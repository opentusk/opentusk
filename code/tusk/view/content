<%doc>
 Copyright 2012 Tufts University 

 Licensed under the Educational Community License, Version 1.0 (the "License"); 
 you may not use this file except in compliance with the License. 
 You may obtain a copy of the License at 

 http://www.opensource.org/licenses/ecl1.php 

 Unless required by applicable law or agreed to in writing, software 
 distributed under the License is distributed on an "AS IS" BASIS, 
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
 See the License for the specific language governing permissions and 
 limitations under the License.
</%doc>
<%args>
	$summary		=> 0
	$SIZE			=> ''
	$OVERLAY		=> 0
</%args>

<%attr>
	top_tab_type            => 'none'
	displayLittleUserNavBar => '1'
	page_footer		=> '/tmpl/footer:footer_with_school_links'
	default_path_type	=> 'content'
	allow_guests		=> '1'
	allow_shib		=> '1'
	syndicate               => '1'
</%attr>

<%shared>
	my $nonScriptPage = $ENV{SCRIPT_URI};
	$nonScriptPage =~ s/content/contentSimple/g;
	my $document = $m->comp('/tmpl/url:get_type_object');
	my $border = "1px solid black";
	my $grayborder = "1px solid lightgrey";
	my $iAmAGuest = HSDB4::Constants::is_guest($m->session->{'user'});
	my $iAmAShibUser = $m->session->{'user'}->isGhost();
	my $userObject = $m->session->{'user'}; #HSDB4::SQLRow::User->new->lookup_key($m->session->{'user'});
	my $iCanEdit = $document->can_user_edit($userObject);
	my $contentPK = $document->primary_key();
	my $redColor = '#CC3300';
	my $blueColor = '#31649B';
	my $defaultHeight = 180;
	my $defaultWidth = 35;
	my $tempWidth;
	my $iconWidth = 27;
	my $imageDir = "/graphics";
	my $closeHandleHeight = 18;
	my $iconsInTopRow = 3;
	my $subMenuStartLocation = $defaultWidth + $iconsInTopRow * ($iconWidth + 6);
</%shared>

<%once>
	use HSDB45::Course;
	use HSDB4::Constants;
	use TUSK::Constants;
	use TUSK::Functions;
	use TUSK::ErrorReport;
	use POSIX;

	use TUSK::Competency::Competency;
	use TUSK::Competency::Content;
</%once>


<%method startup>
<%args>
$args => {}
</%args>
  <%perl>
	if($iAmAShibUser) {
		my $canView = 0;
		my $courseShares = TUSK::Course::CourseSharing->new()->getCurrentSharedCourses($userObject->field_value('sid'));
		# We have courses, now lets see if any of the shares are to a course related to this content....
		# 1st put all of the shared course IDs into a hash
		my %courseShareIds;
		foreach my $sharedCourse (@{$courseShares}) {
			$courseShareIds{$sharedCourse->primary_key} = 1;
		}
		# for each of the courses linked to the content check to see if the id was one of the shared course
		foreach my $course ($document->linked_courses) {
			if(exists($courseShareIds{$course->primary_key})) {$canView=1;}
		}

		unless($canView) {
			# We cant view this so re-direct my to /home with a message saying that a shib user is not allowed to view the document.
			$m->comp("/tmpl/url:redirect",message => __("FAILURE : Content was not shared with you"));
		}
	}
#print pre_dump($m->session);
    $m->comp("SELF:set_no_cache");
    $m->comp("SELF:set_unicode");
  </%perl>
</%method>


<%method red_header_class>
%	return 'blueHeaderBar';
</%method>

<%method red_header_text>
%     return "<b>" . $document->out_label."</b>"; 
</%method>

<%method right_header_text>
<%doc>Method that returns a list of all the images to use to the right on the red header bar</%doc>
<%perl>

my $right_hdr_lnks = [];
if($iCanEdit){
	my $edit_lnk = $m->comp('/tmpl/url:get_edit_link', content => $document);
	push @$right_hdr_lnks, $edit_lnk;
}
return $right_hdr_lnks;

</%perl>
</%method>


<%method title>
%	return ucfirst($document->type) .": ". $document->out_label;
</%method>


<%method jsarray>
%	return [ "drag.js", "content.js", "flashcards.js", "jquery/jquery.min.js" ];
</%method>


<%method stylearray>
<%perl>
	my $css = ["/style/style.css"];
	push (@$css, "/style/hscml.css") if ($document->type() eq 'TUSKdoc' or ($document->type() eq 'Document' && $document->conversion_status() > 1));
	return $css;
</%perl>
</%method>


<%doc>Redirect if we are not url</%doc>
% if($document->display_framed) {
%       my $location = $ENV{SCRIPT_URI};
%       $location =~ s/view\/content/view\/url/;
%	$m->redirect($location);
% }
<%doc>Or if we are using simple content/course stuff</%doc>
% if($m->session->{'contentDisplay'} eq 'simple') {
%     $m->redirect($nonScriptPage);
% }


% unless($iCanEdit || $document->is_active()) {
	<br><br>
	<table border="0" width="100%">
	  <tr><th><font size="+2"><%__('Sorry this content is not currently active.')%></font></th></tr>
	</table>
	<br><br>
%    return();
% }

% my $tempSize = 'large';
% if($document->type eq 'Slides') {
%	if($document->overlay_data)                 {$tempSize = "large";}
%	elsif($document->image_available("xlarge")) {$tempSize = "xlarge";}
% }
% if($SIZE && ( $SIZE eq 'medium' || $SIZE eq 'orig' || $SIZE eq 'large' || $SIZE eq 'xlarge' )) {
%	$m->session->{'contentImageSize'} = $SIZE;
% } else {
%	if($m->session->{'contentImageSize'}) {$ARGS{'SIZE'} = $m->session->{'contentImageSize'};}
%	else                                  {$ARGS{'SIZE'} = $tempSize;}
% }

<script>
  function localOnLoad() {
    if(!document.getElementById('contentFrameForFiles')) {return;}
    //Attempt to resize the frame to match the content within it.
    var theFrame = document.getElementById('contentFrameForFiles');
    if(theFrame.contentDocument && theFrame.contentDocument.body && theFrame.contentDocument.body.offsetHeight)
      {theFrame.style.height = theFrame.contentDocument.body.offsetHeight;}
    else if(theFrame.Document && theFrame.Document.body && theFrame.Document.body.scrollHeight)
      {theFrame.style.height = theFrame.Document.body.scrollHeight;}
    else if(!navigator.userAgent.search(/Safari/)) 
      {theFrame.style.height = "0px"; theFrame.style.width = "0px"; theFrame.style.border = "0px none";}
  }

% if ($document->type() eq 'TUSKdoc'){
	function showTUSKdocMessages(){
		var msg_count = 0;
		var spanArray = document.getElementsByTagName("span");

		for(var i=0; i < spanArray.length; i++){
			if (spanArray[i].className == 'conversion-note' || spanArray[i].className == 'conversion-exception'){
				msg_count++;
				if (spanArray[i].style.display == 'none' || spanArray[i].style.display == ''){
					spanArray[i].style.display = 'inline';
				}
				else{
					spanArray[i].style.display = 'none';
				}
			}
		}
		if (!msg_count) {
			alert("There are no messages to display.");
		}
	}


% }
</script>

<%doc>This div is used by the floating nav bar for highlighting key terms.</%doc>
<div class="checkedBG">
&nbsp;
<img align="left" border="0" width="1px" src="/graphics/spacer.gif" height="325px">

<noscript><center><b><%__x('Your browser does not support JavaScript!<br>Try using the non-scripted content page by <a href="{non_script_url}">clicking here</a></b>', non_script_url => $nonScriptPage)%></center></noscript>
<%doc>Create the floating navigation bar.</%doc>
<& SELF:printNavBardwithJavaScripts, SIZE => $ARGS{'SIZE'}, summary => $summary &>

<%doc>This anchor was in the legacy content.</%doc>
<a name="_top"></a>
% if($iCanEdit && !$document->is_active()) {
	<center><div style="margin-top:10px; margin-right:30px; margin-bottom:20px; margin-left:125px; border:2px solid red; background-color:white;"><%__('This content has expired!<br>You are only able to see it because you are an editor')%></div></center>
% }

<& SELF:display_content, summary => $summary, document => $document, %ARGS &>

&nbsp;
</div>

<%doc>*******************************
	Done with body here.
	Below are methods.
******************************</%doc>




<%method printNavBardwithJavaScripts>
	<%args>
	  $SIZE
	  $summary
	</%args>
%    my $handleWidth = 10;
%    $m->session->{'contentMenuLocation'}->{'optionsDiv'}->{'x'} ||= $defaultWidth;
%    $m->session->{'contentMenuLocation'}->{'optionsDiv'}->{'y'} ||= $defaultHeight;
%    my @tempKeywords = $document->keywords("concept_id is null");
%    my @keyWords = map { $_->getKeyword() } @tempKeywords;
%    my @context = $document->other_parents;
%    my @subContent = $document->active_child_content();
<%perl>
     my $content_objectives = TUSK::Competency::Competency->lookup( 'competency_content.content_id ='. $document->primary_key, ['sort_order'], undef, undef,
			          [TUSK::Core::JoinObject->new('TUSK::Competency::Content', {origkey => 'competency_id', joinkey => 'competency_id', jointype => 'inner'})]);
     my @objectives = @{$content_objectives};
</%perl>
%    my @concepts = $document->UMLSkeywords;
%    my $printIconWidth = "width=\"$iconWidth\" height=\"$iconWidth\"";
%    my $linkedFrom = 0;
%    if(@context > 0 && ($document->field_value('style') !~ /Liver/)) {$linkedFrom = 1;}

	<style type="text/css"><!--
	.mouseOverIcon {background-color: yellow;}
	.openedSubMenu {background-color: #00CC66;}
	.hiddenDiv, .tableWithLittleFont {
		font-family: Arial, Helvetica, sans-serif;
		font-size: 8pt;
	}
	.hiddenDiv {
		background-color: white;
		layer-background-color: white;
 		border: 1px solid #000000;
		overflow: auto;
		z-index: 9999;
		left: <% ($iconWidth * $iconsInTopRow)+(3*6) %>px;
		position:absolute;
		width:250px;
	}
	--></style>
        <& SELF:printNavBarJavaScript, numberOfContent => (scalar @subContent) &>
	
	<div id="loadingImageDiv" style="display:none; position:absolute; top:0px; left:0px;" onClick="this.style.display='none';">
          <!--
          <table border="0" cellspacing="0" cellpadding="0">
            <tr><td><img id="theLoadingImage" src="/graphics/Loading.gif"></td></tr>
            <tr><td align="right"><font style="align:right; font-size:8pt;">Click To Close</font></td></tr>
          </table>
          -->
	</div>

%	$tempWidth = $subMenuStartLocation;
%	if($m->session->{'contentMenuLocation'}->{'optionsDiv'}->{'x'} > $tempWidth) {$tempWidth = $defaultWidth;}

        <& SELF:printNotesForm &>
        <& SELF:printSaveForm &>
		<& SELF:printFlashCardsForm &>
        <& SELF:printContentForm &>
        <& SELF:printObjectiveForm, objectivesRef => \@objectives &>
        <& SELF:printPrintForm, SIZE => $SIZE, summary => $summary, numberOfSubContent => (scalar @subContent) &>
        <& SELF:printKeywordsForm, keyWordsRef => \@keyWords, conceptsRef => \@concepts &>
        <& SELF:printLinkedDocsForm, contextRef => \@context, subContentRef => \@subContent, linkedFrom => $linkedFrom &>
        <& SELF:printZoomForm, SIZE => $SIZE &>


	<div id="optionsDiv" style="position:absolute; z-index:9997; left: <% $m->session->{'contentMenuLocation'}->{'optionsDiv'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'optionsDiv'}->{'y'} %>px; ">
	    <table width="<% $iconWidth+$handleWidth %>" border="0" cellspacing="0" cellpadding="3" style="border:1px solid black;" bgcolor="white">
	      <tr><td height="<% $handleWidth %>" colspan="<% $iconsInTopRow %>" bgcolor="<% $blueColor %>" id="optionsDivHandle" style="cursor:move; border-bottom:1px solid black;padding:0;"><img src="/graphics/spacer.gif" height="1" width="1"></td></tr>
	      <tr>
% my $rowspan = 11;
% if($document->type() eq 'TUSKdoc' or (defined($document->conversion_status) && $document->conversion_status > 0)) {$rowspan++;}
% if($iCanEdit && $userObject->primary_key) {$rowspan+=2;}
	        <td class="button" nowrap="nowrap">
%			my $prev = $document->context_prev;
%			my $title = __("Previous Document");
%			my $background = '';
%			if($prev) {
%			  $title.= ": " . $prev->out_abbrev();
%			  $background = "onClick=\"document.location='" . $prev->out_url() . "';\"";
%			}
        		<span class="contentbutton <% ($prev) ? 'active ': '' %>previous" title="<% $title %>" <% $background %>><% __('prev') %></span>
	        </td>

	        <td class="button" nowrap="nowrap">
%		my $collection = $document->context_parent;
%		$title = __("To Collection");
%		$background = '';
%		if($collection) {
%		  $title.= ": " . $collection->out_abbrev();
%		  $background = "onClick=\"document.location='" . $collection->out_url() . "';\"";
%		}
	        	<span class="contentbutton  <% ($collection) ? 'active ': '' %>up" title="<% $title %>" <% $background %>><% __('up') %></span>
	        </td>

	        <td class="button" nowrap="nowrap">
%		my $next = $document->context_next;
%		$title = __("Next Document");
%		$background = 'style="background-color: lightgrey;"';
%		if($next) {
%		  $title.= ": " . $next->out_abbrev();
%		  $background = "onClick=\"document.location='" . $next->out_url() . "';\"";
%		}
	        	<span class="contentbutton  <% ($next) ? 'active ': '' %>next" title="<% $title %>" <% $background %>><% __('next') %></span>

	        </td>
	      </tr>

<%doc>check on the active attribute below</%doc>
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Keywords'),
                        menuItemHelpText        => 'Keywords/UMLS Concepts',
                        onClick                 => "displayForm('theKeyWordForm', this);",
			active			=> (scalar(@keyWords) || scalar(@concepts)),
                &>
%	if($document->type() eq 'TUSKdoc' or (defined($document->conversion_status) && $document->conversion_status > 0)) {
%		if ($summary) {
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Full Doc'),
                        menuItemHelpText        => __('View Full Document'),
                        onClick                 => "document.location='$ENV{SCRIPT_URI}?summary=0';",
                &>
%		} else {
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Doc Summary'),
                        menuItemHelpText        => __('View Document Summary'),
                        onClick                 => "document.location='$ENV{SCRIPT_URI}?summary=1';",
                &>

%	}
% }

<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Objectives'),
                        menuItemHelpText        => __('View Content Objectives'),
                        onClick                 => "displayForm('theContentObjectiveForm', this);",
			active			=> scalar(@objectives),
                &>
%		unless($iAmAGuest || $iAmAShibUser) {
%		  my @notes = $document->child_personal_content($m->session->{'user'}->primary_key());
%		  my $imageIcon = '';
%		  foreach (@notes) {
%		    if($_->field_value('body') =~ /\S/) {
%		            $imageIcon = '<img src="/icons/ico-newsm.gif" align="right" alt="You have notes for this content" title="You have notes for this content">';
%                     last;
%                   }
%	  	  }
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Notes&nbsp;'),
                        menuItemHelpText        => __('View Notes'),
			onClick			=> "displayForm('theNotesForm', this);",
			extraImg		=> $imageIcon,
                &>
%		  if($document->content_type() eq 'Collection') {
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Full&nbsp;Notes'),
                        menuItemHelpText        => __('Show full content notes'),
			onClick			=> 'displayContentNotes(this);',
			showArrow		=> 0,
                &>
% my $collectionNotesPage = $ENV{SCRIPT_URI};
% $collectionNotesPage =~ s/view\/content[^\/]*/view\/collectionnotes/;
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Folder&nbsp;Notes'),
                        menuItemHelpText        => __('Take notes on all items in collection'),
			onClick			=> "document.location='$collectionNotesPage'",
			showArrow		=> 0,
                &>
%		  }
%		}

<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Linked&nbsp;From'),
                        menuItemHelpText        => __('View Linked Documents'),
                        onClick                 => "displayForm('theLinkedDocsForm', this);",
			active			=> $linkedFrom,
                &>
%		if(($document->type eq "Slide") || ($document->type eq "Flashpix"))
%		{
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Image&nbsp;Zoom'),
                        menuItemHelpText        => __('Zoom Image'),
                        onClick                 => "displayForm('theZoomForm', this);",
			menuID			=> 'topZoomImage',
                &>
%		}
%		unless($iAmAGuest || $iAmAShibUser) {
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('My&nbsp;Folders'),
                        menuItemHelpText        => __('Folder'),
                        onClick                 => "displayForm('theSaveForm', this);",
                &>
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('My&nbsp;Flash&nbsp;Cards'),
                        menuItemHelpText        => __('Folder'),
                        onClick                 => "displayForm('theFlashCardsForm', this);",
                &>
%		}
<& SELF:displayContentOptionMenuItem,   
                        menuItemText            => __('Print'),
                        menuItemHelpText        => __('Print Document'),
                        onClick                 => "displayForm('thePrintForm', this);",
                &>
%	if($iCanEdit && $userObject->primary_key) {

% if ($document->type() eq 'TUSKdoc'){
<& SELF:displayContentOptionMenuItem,
                        menuItemText            => __('TUSKdoc&nbsp;Msgs'),
                        menuItemHelpText        => __('Show messages generated by the Word to TUSKdoc process.'),
                        onClick                 => 'showTUSKdocMessages()',
			showArrow		=> 0,
                &>
% }
<& SELF:displayContentOptionMenuItem,
                        menuItemText            => __('History'),
                        menuItemHelpText        => __('Content History'),
                        onClick                 => "document.location='/view/content_history/" . $document->primary_key . "'",
			showArrow		=> 0,
                &>
%	}
<& SELF:displayContentOptionMenuItem,
                        menuItemText            => __('Info'),
                        menuItemHelpText        => __('View Content Info'),
                        onClick                 => "displayForm('theContentInfoForm', this);",
                &>
	    </table>



        </div>
	<script>
          registerDragItem('theNotesForm', 'top', 'left', 'saveMenuLocation("theNotesForm")');
          registerDragItem('theSaveForm', 'top', 'left', 'saveMenuLocation("theSaveForm")');
          registerDragItem('theFlashCardsForm', 'top', 'left', 'saveMenuLocation("theFlashCardsForm")');
          registerDragItem('optionsDiv', 'top', 'left', 'saveMenuLocation("optionsDiv")');
          registerDragItem('theContentInfoForm', 'top', 'left', 'saveMenuLocation("theContentInfoForm")');
          registerDragItem('theContentObjectiveForm', 'top', 'left', 'saveMenuLocation("theContentObjectiveForm")');
          registerDragItem('thePrintForm', 'top', 'left', 'saveMenuLocation("thePrintForm")');
          registerDragItem('theLinkedDocsForm', 'top', 'left', 'saveMenuLocation("theLinkedDocsForm")');
          registerDragItem('theKeyWordForm', 'top', 'left', 'saveMenuLocation("theKeyWordForm")');
          registerDragItem('theZoomForm', 'top', 'left', 'saveMenuLocation("theZoomForm")');
        </script>
</%method>





<%method printNavBarJavaScript>
  <%args>
    $numberOfContent
  </%args>

	<script>
	  var saveFormOut = 0;
	  var printFormOut = 0;
	  var keyWordFormOut = 0;
	  var contentFormOut = 0;
	  
	  var theContent = '';
	  var Text = new Array();
	  var Tags = new Array();
	  
	  function saveMenuLocation(divName) {
	    var ajaxRequest;
            var divToMove = document.getElementById(divName);
      	    var x = divToMove.style.left.replace('px', '');
      	    var y = divToMove.style.top.replace('px', '');
	    var url = "/tusk/ajax/saveContentMenuInfo?toSave=formLocation&x_value="+ encodeURIComponent(x) +"&y_value="+ encodeURIComponent(y) +"&divToSave="+ encodeURIComponent(divName);
	  
	    if (window.XMLHttpRequest) {ajaxRequest = new XMLHttpRequest();}
	    else if (window.ActiveXObject) {ajaxRequest = new ActiveXObject("Microsoft.XMLHTTP");}
	    ajaxRequest.open("GET", url, false);
	    ajaxRequest.send(null);
	  }
          
          function turnOffLoadImage() {
            if(document.getElementById('loadingImageDiv')) {document.getElementById('loadingImageDiv').style.display='none';}
            if(document.getElementById('loadingDiv')) {document.getElementById('loadingDiv').style.display='none';}
          }

	  function getTheContent() {
	    theContent = document.getElementById('pageContent').innerHTML;
        
	    var windowWidth;
	    if(window.innerWidth)              {windowWidth = window.innerWidth;}
	    else if(document.body.offsetWidth) {windowWidth = document.body.offsetWidth;}
	    else                               {windowWidth = 0;}
	    var windowHeight;
	    if(window.innerHeight)              {windowHeight = window.innerHeight;}
	    else if(document.body.offsetHeight) {windowHeight = document.body.offsetHeight;}
	    else                                {windowHeight = 0;}
            //If the optionsDiv is off the page then move it back to the default locations.
	    if((parseInt('<% $m->session->{'contentMenuLocation'}->{'optionsDiv'}->{'x'} %>') > windowWidth) ||
	       (parseInt('<% $m->session->{'contentMenuLocation'}->{'optionsDiv'}->{'y'} %>') > windowHeight)
	      ) {
 	      document.getElementById('optionsDiv').style.top = '<% $defaultHeight %>px';
	      document.getElementById('optionsDiv').style.left = '<% $defaultWidth %>px';
              saveMenuLocation('optionsDiv');
              
              //If we've moved that back then lets move back the rest of the stuff.
              for(var index=0; index<formNames.length; index++) {
 	        document.getElementById(formNames[index]).style.top = '<% $defaultHeight %>px';
	        document.getElementById(formNames[index]).style.left = '<% $subMenuStartLocation %>px';
                saveMenuLocation(formNames[index]);
              }
	    }

%  if($m->session->{'contentMenuLastOpened'}->{'formToDisplay'} && $m->session->{'contentMenuLastOpened'}->{'iconID'}) {
            displayForm('<% $m->session->{'contentMenuLastOpened'}->{'formToDisplay'} %>', document.getElementById('<% $m->session->{'contentMenuLastOpened'}->{'iconID'} %>'));
%  }
	    localOnLoad();
	  }
	  window.onload=getTheContent;
          window.onunload=turnOffLoadImage;
	  
	  var lastAnchor = 0;
          var lastHighlighted = '';
          function goToMatch(nextOrPrevious, currentCounter) {
            if(nextOrPrevious == 'n') {
	      currentCounter++;
              if(!document.getElementById('TUSK_TEMP_A_'+currentCounter)) {currentCounter = 0;}
            } else {
	      currentCounter--;
              if(!document.getElementById('TUSK_TEMP_A_'+currentCounter)) {currentCounter = lastAnchor-1;}
            }
            
            if(lastHighlighted && document.getElementById(''+lastHighlighted)) {document.getElementById(''+lastHighlighted).className='highlight';}
	    lastHighlighted = 'TUSK_TEMP_SPAN'+currentCounter;
            document.getElementById(''+lastHighlighted).className='currentHightlight';

            var currentLocation = ''+document.location;
            if(currentLocation.search(/#/) == -1) {
              document.location = currentLocation + '#TUSK_TEMP_A_'+currentCounter;
            } else {
	      document.location = currentLocation.replace(/#.*$/, '#TUSK_TEMP_A_'+currentCounter);
            }
          }
       
	  var alreadySaidOK = 0;
	  function highlightWords() {
	    if(theContent == '') {
	      alert(_('Please wait for the page to finish loading.'));
	      for(var index=l; index<document.theTuskWordForm.keyWords.length; index++) {
	        document.theTuskWordForm.keyWords[index].selected = false;
	      }
	      return;
	    }
%  if($document->content_type() eq 'Collection') {
            //Check if we are making an ajax call.
            if(loadingContent) {alert(_('Please wait for the content to finish loading.')); return;}
            //Load all of the content again.
            theContent = document.getElementById('pageContent').innerHTML;
%  }
	    //Get the selcted Key Words on the list.
	    var selectedKeyWords = '';
	    var numberOfSelectedKeyWords = 0;
	    for(var index=0; index<document.theTuskWordForm.keyWords.length; index++) {
	      if(document.theTuskWordForm.keyWords[index].selected) {
	        selectedKeyWords += "(" + document.theTuskWordForm.keyWords[index].value + ")|";
	        numberOfSelectedKeyWords++;
	      }
	    }
	    selectedKeyWords = selectedKeyWords.replace(/\|$/, '');
	    var tempContent = theContent;
	    if(selectedKeyWords != '') {
	      if((numberOfSelectedKeyWords > 10) && !alreadSaidOK) {
	        var tooMany = _("You have selected more than 10 key words.\nI can highlight them all but it may take some time.\nDo you want me to continue? (I wont ask again on this page if you say ok)");
	        if(!confirm(tooMany)) {return true;} else {alreadySaidOK = 1;}
	      }
	      var theRegExp = new RegExp("([^_\/\"])("+selectedKeyWords+")[^<]", 'i');
	
	      
	      //Highlight the selected key words.
	      lastAnchor = 0;
              while(theRegExp.test(tempContent)) {
	        tempContent = tempContent.replace(theRegExp, '$1 <img src="/graphics/prevMatch.gif" onClick="goToMatch(\'p\', '+lastAnchor+');"><a id="TUSK_TEMP_A_'+lastAnchor+'" name="TUSK_TEMP_A_'+lastAnchor+'"><span id="TUSK_TEMP_SPAN'+lastAnchor+'" class="highlight">$2</span><img src="/graphics/nextMatch.gif" onClick="goToMatch(\'n\', '+lastAnchor+');"> ');
	        lastAnchor++;
	        if(lastAnchor > 1000) {alert('thats alot of stuff... breaking'); last;}
              }
	      document.getElementById('pageContent').innerHTML = tempContent;
	    }
	  }
	   
	  var formNames = new Array('theSaveForm', 'theFlashCardsForm', 'theZoomForm', 'thePrintForm', 'theKeyWordForm', 'theContentInfoForm', 'theLinkedDocsForm', 'theNotesForm', 'theContentObjectiveForm');
	  
	  var lastImageTurnedOn;
	  var savedIcon;

	  function displayForm(formToDisplay, icon) {
            var ajaxAction = 'formOpened';;
		if (icon) { 
			savedIcon = icon;
		}else {
			icon = savedIcon;
		}
	    if(document.getElementById(formToDisplay).style.display == '') {
              ajaxAction = 'formClosed';;
	      document.getElementById(formToDisplay).style.display = 'none';
	      icon.className = '';
	      lastImageTurnedOn = '';
	    } else {
	      icon.className = 'openedSubMenu';
	      if(lastImageTurnedOn) {lastImageTurnedOn.className = '';}
	      lastImageTurnedOn = icon;
	      for(var index=0; index<formNames.length; index++) {
	        document.getElementById(formNames[index]).style.display='none';
	        document.getElementById(formToDisplay).style.display='';
	      }
	    }
        
        //ajax save the last poped up form.
	    var ajaxRequest;
	    var url = "/tusk/ajax/saveContentMenuInfo?toSave="+encodeURIComponent(ajaxAction)+"&formToDisplay="+ encodeURIComponent(formToDisplay) +"&iconID="+ encodeURIComponent(icon.id);

	    if (window.XMLHttpRequest) {ajaxRequest = new XMLHttpRequest();}
	    else if (window.ActiveXObject) {ajaxRequest = new ActiveXObject("Microsoft.XMLHTTP");}

	    ajaxRequest.open("GET", url, false);
	    ajaxRequest.send(null);
	  }

          function removeHighlighting(theImage) {
	    if(theImage.className != 'openedSubMenu') {theImage.className = '';}
	  }

	  function highlightButton(theImage) {
	    if(theImage.className != 'openedSubMenu') {theImage.className = 'mouseOverIcon';}
	  }
	    
	  function submitToPrint(toPreview) {
            if(toPreview) {
              document.theTuskPrintForm.target = '';
              document.theTuskPrintForm.preview.value='0';
            } else {
              document.theTuskPrintForm.target = 'printFrame';
              document.theTuskPrintForm.preview.value='1';
            }
% if($document->type =~ /Collection/) {
	    for(var index=0; index<document.theTuskPrintForm.slidesPerPage.length; index++) {
	      if(document.theTuskPrintForm.slidesPerPage[index].checked) {
		var slidesPerPage = document.theTuskPrintForm.slidesPerPage[index].value.substr(-1,1);
	        document.theTuskPrintForm.action = document.theTuskPrintForm.slidesPerPage[index].value;
	        if((<% $numberOfContent %>/slidesPerPage) > 10) {alert(_('This collection contains more than ten pages of images.\nWe suggest you print five pages at a time.'));}
	        document.theTuskPrintForm.submit();
	      }
	    }
% } else {
	  var selectedKeywords = '';
	  if(document.theTuskWordForm.keyWords) {
		for(var index=0; index<document.theTuskWordForm.keyWords.length; index++) {
	  if(document.theTuskWordForm.keyWords[index].checked) {
		selectedKeywords += document.theTuskWordForm.keyWords[index].value+'|';
	  }
		}
	  }
	  document.theTuskPrintForm.action = '/tusk/view/printcontent/<% $document->primary_key %>';
	  document.theTuskPrintForm.hiddenWords.value = selectedKeywords;
	  document.theTuskPrintForm.submit();
% }
	  }
      
	  function loadImage(imageSizeToLoad) {
	    displayForm('theZoomForm', document.getElementById('topZoomImage'));
	    var windowWidth;
	    if(window.innerWidth)              {windowWidth = window.innerWidth;}
	    else if(document.body.offsetWidth) {windowWidth = document.body.offsetWidth;}
	    else                               {windowWidth = 0;}
	    var windowHeight;
	    if(window.innerHeight)              {windowHeight = window.innerHeight;}
	    else if(document.body.offsetHeight) {windowHeight = document.body.offsetHeight;}
	    else                                {windowHeight = 0;}
	    var loadingImageDiv = document.getElementById('loadingImageDiv');
	    loadingImageDiv.style.top = (windowHeight/2)-50 + "px";
	    loadingImageDiv.style.left = (windowWidth/2)-100 + "px";
	    loadingImageDiv.style.display = '';
	    document.location="<% $ENV{SCRIPT_URI} %>?SIZE="+imageSizeToLoad;
	  }
	</script>
</%method>



<%method printDragHandleWithClose>
  <%args>
    $formName
    $title
    $imageName
  </%args>

    <div style="background-color:<% $blueColor %>; cursor:move; border-bottom:1px solid black; top:0px; right:0px; left:0px; height:<% $closeHandleHeight %>px;" id="<% $formName %>Handle">
      <table border="0" style="width:100%; height:<% $closeHandleHeight %>px;" cellspacing="0" cellpadding="0">
        <tr style="z-index:9997;">
          <td valign="middle" align="left"><font style="color:lightgrey; font-size:10px;"><% $title %></font></td>
	  <td valign="middle" align="right">
            <font style="color:lightgrey; font-size:10px; cursor:pointer;" onClick="displayForm('<% $formName %>');">
              <%__('Close')%>
              <font style="border:1px solid lightgrey;">&nbsp;<b>X</b>&nbsp;</font>
            </font>
          </td>
        </tr>
      </table>
    </div>
</%method>



<%method printContentForm>
%  my @authors = $document->child_authors;
%  my $formWidth = 300;
%  my $formHeight = 150;
%  $m->session->{'contentMenuLocation'}->{'theContentInfoForm'}->{'x'} ||= $tempWidth;
%  $m->session->{'contentMenuLocation'}->{'theContentInfoForm'}->{'y'} ||= $defaultHeight;

  <div id="theContentInfoForm" class="hiddenDiv" style="z-index:9999; width:<% $formWidth %>px; height:<% $formHeight %>px; display:none; left:<% $m->session->{'contentMenuLocation'}->{'theContentInfoForm'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'theContentInfoForm'}->{'y'} %>px; overflow:hidden;">
    <& SELF:printDragHandleWithClose, formName => 'theContentInfoForm', title => __('Info'), imageName => 'infoButton' &>
    <div style="z-index:9996; width:<% $formWidth %>px; height: <% $formHeight - $closeHandleHeight %>px; overflow:auto;">
      <table border="0" cellspacing="0" width="100%" class="tableWithLittleFont">
        <tr><td align="right"><b><%__('School')%>:</b></td><td><% ucfirst($document->field_value("school")) %></td></tr>
        <tr><td align="right"><b><%__('Content&nbsp;ID')%>:</b></td><td><% $document->primary_key %></td></tr>
%  if($document->course) {
        <tr><td align="right" valign="top"><b><%__('Course')%></b>:</td><td><% $document->course->out_html_label %></td></tr>
%  }
	
%  if(@authors) {
        <tr>
          <td valign="top" align="right"><b><%__('Authors')%></b>:</td>
          <td valign="top">
%  if(scalar(@authors) > 4) {$m->print('<div id="authorsDiv" class="multiselectdiv">');}
            <ul style="padding-left:20px;">
%    foreach my $author (@authors) {
              <li><% $author->out_html_full_name %></li>
%    }
            </ul>
%    if(scalar(@authors) > 4) {$m->print('</div>');}
          </td>
        </tr>
%  }
	
%  if($document->type() eq 'TUSKdoc' or $document->conversion_status > 1) {
        <tr>
          <td valign="top" align="right"><b>Key</b>:</td>
          <td>
            <div class="hscml_key">
              <span class="nugget">&nbsp;nugget&nbsp;</span>
              <span class="keyword">&nbsp;keyword&nbsp;</span>
              <span class="objective-item">&nbsp;objective&nbsp;</span>
              <span class="topic-sentence">&nbsp;topic-sentence&nbsp;</span>
              <span class="summary">&nbsp;summary&nbsp;</span>
              <span class="warning">&nbsp;warning&nbsp;</span>
            </div>
          </td>
        </tr>
%  }
      </table>
    </div>
  </div>
</%method>



<%method printNotesForm>
%  my $notesLocation = $ENV{'SCRIPT_URI'};
%  $notesLocation =~ s/view\/content[^\/]*/view\/contentnotes/;
%  $m->session->{'contentMenuLocation'}->{'theNotesForm'}->{'x'} ||= $tempWidth;
%  $m->session->{'contentMenuLocation'}->{'theNotesForm'}->{'y'} ||= $defaultHeight;

  <div id="theNotesForm" class="hiddenDiv" style="z-index:9999; left:<% $m->session->{'contentMenuLocation'}->{'theNotesForm'}->{'x'} %>px; top:<% $m->session->{'contentMenuLocation'}->{'theNotesForm'}->{'y'} %>px; width:402px; height:268px; display:none; overflow:hidden;">
    <& SELF:printDragHandleWithClose, formName => 'theNotesForm', title => __('Notes'), imageName => 'displayNotesFormImage' &>
    <iframe id="theNotesFormBody" src="<% $notesLocation %>" style="border:0px none; width:400px; height:250px; overflow:hidden;">
    </iframe>
  </div>  
</%method>


<%method printObjectiveForm>
  <%args>
    $objectivesRef
  </%args>

%  my @objectives = @{$objectivesRef};
%  my $formWidth = 400;
%  my $formHeight = 250;
%  $m->session->{'contentMenuLocation'}->{'theContentObjectiveForm'}->{'x'} ||= $tempWidth;
%  $m->session->{'contentMenuLocation'}->{'theContentObjectiveForm'}->{'y'} ||= $defaultHeight;

  <div id="theContentObjectiveForm" class="hiddenDiv" style="z-index:9999; width:<% $formWidth %>px; height:<% $formHeight %>px; display:none; left:<% $m->session->{'contentMenuLocation'}->{'theContentObjectiveForm'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'theContentObjectiveForm'}->{'y'} %>px; overflow:hidden;">
    <& SELF:printDragHandleWithClose, formName => 'theContentObjectiveForm', title => __('Objectives'), imageName => 'objectiveButton' &>
    <div id="innerObjectiveDiv" style="width:<% $formWidth %>px; height: <% $formHeight - $closeHandleHeight %>px; overflow:auto;">
%  if(@objectives) {
      <ul style=""padding-left:20px;">
%    foreach my $objective (@objectives) {
        <li><% $objective->getDescription %></li>
%    }
      </ul>
%  } else {
      <b><center><%__('None')%></center></b>
%  }
    </div>
  </div>
</%method>




<%method printPrintForm>
  <%args>
    $SIZE
    $summary
    $numberOfSubContent
  </%args>

  <%perl>
    my $addPrintButton = 1;
    my $formWidth = 200;
    my $formHeight = 250;
    # when image is wider than ~725px, it gets cut off during printing.
    # fortunately, size 'xlarge' is 700px wide. if 'orig' size is
    # selected when printing, set size to xlarge. 
    $SIZE = (!$SIZE || $SIZE eq 'orig')? 'xlarge' : $SIZE; 
    $m->session->{'contentMenuLocation'}->{'thePrintForm'}->{'x'} ||= $tempWidth;
    $m->session->{'contentMenuLocation'}->{'thePrintForm'}->{'y'} ||= $defaultHeight;
  </%perl>

  <div id="thePrintForm" class="hiddenDiv" style="z-index:9999; width:<% $formWidth %>px; height:<% $formHeight %>px; display:none; left:<% $m->session->{'contentMenuLocation'}->{'thePrintForm'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'thePrintForm'}->{'y'} %>px; overflow:hidden;">
% my $title = __("Print Content");
% if($document->type() eq 'TUSKdoc' or (defined($document->conversion_status) && $document->conversion_status > 0)) {$title = "Print or Download Content";}

    <script>
      function turnOnPrintPreview(display) {
        if(document.theTuskPrintForm.previewButton) {document.theTuskPrintForm.previewButton.style.display = display;}
      }
    </script>

    <& SELF:printDragHandleWithClose, formName => 'thePrintForm', title => $title, imageName => 'printFormButton' &>
    <div id="innerObjectiveDiv" style="width:<% $formWidth %>px; height: <% $formHeight - $closeHandleHeight %>px; overflow:auto;">
      <form name="theTuskPrintForm" method="get" target="printFrame" action="/tusk/view/printcontent/<% $document->primary_key %>">
        <input type="hidden" name="summary" value="<% $summary %>">
        <input type="hidden" name="SIZE" value="<% $SIZE %>">
        <input type="hidden" name="hiddenWords" value="">
        <input type="hidden" name="preview" value="">
        <table border="0" width="100%" class="tableWithLittleFont">
          <tr><td>
%  if($document->type =~ /Collection/) {
%    if($document->contains_slides) {
            <p>Slides<br>
%      foreach my $numSlides (6,4,3,2) {
%        my $numberOfPages = ceil($numberOfSubContent/$numSlides);
%	 if($numberOfPages != 1) {$numberOfPages = $numberOfPages . " pages";}
%	 else                    {$numberOfPages = "1 page";}
	      &nbsp; <input type="radio" name="slidesPerPage" value="/view/printcollection/<% $document->primary_key %>/<% $numSlides %>"><% $numSlides %> <%__('slides per page')%> (<font style="font-size:6pt;"><% $numberOfPages %></font>)<br>
%      }
	    </p>
%    } else {
            <p style="color:gray;">
              <%__('This collection has no slides.<br>Thus it could not be printed.<br><br>If you are trying to print a collection of slides which is under this collection, click on the name of the collection then use the print option on that page.')%>
            </p>
%      $addPrintButton = 0;
%    } 
%  } else {
            <p id="standardPrintOptions" style="font-color:red;">
              <input type="checkbox" name="addNotes" <% $m->session->{'contentPrintOptions'}->{addNotes} %>><%__('Add my notes.')%><br>
              <input type="checkbox" name="addContentInfo" <% $m->session->{'contentPrintOptions'}->{addContentInfo} %>><%__('Add content info.')%><br>
              <input type="checkbox" name="addKeywords" <% $m->session->{'contentPrintOptions'}->{addKeywords} %>><%__('Add key words')%>.<br>
              <input type="checkbox" name="addUMLS" <% $m->session->{'contentPrintOptions'}->{addUMLS} %>><%__('Add UMLS Concepts.')%><br>
              <input type="checkbox" name="addObjectives" <% $m->session->{'contentPrintOptions'}->{addObjectives} %>><%__('Add Objectives.')%><br>
              <input type="checkbox" name="addLinkedTo" <% $m->session->{'contentPrintOptions'}->{addLinkedTo} %>><%__('Add linked to.')%><br>
              <input type="checkbox" name="addLinkedFrom" <% $m->session->{'contentPrintOptions'}->{addLinkedFrom} %>><%__('Add linked from.')%><br>
            </p>
%  }
          </td></tr>
%  if($addPrintButton) {
          <tr><td align="center">
            <input type="button" name="previewButton" class="formbutton" value="<%__("Print Preview")%>" onClick="submitToPrint(true);">
            <input type="button" name="Print" class="formbutton" value=<%__("Print")%> onClick="submitToPrint(false);">
          </td></tr>
%  }
        </table>
      </form>
      <iframe name="printFrame" style="height:1px; width:1px; border:0px;"></iframe>
    </div>
  </div>
</%method>

<%method printFlashCardsForm>
%  my $formWidth = 200;
%  my $formHeight = 150;
%  $m->session->{'contentMenuLocation'}->{'theFlashCardsForm'}->{'x'} ||= $tempWidth;
%  $m->session->{'contentMenuLocation'}->{'theFlashCardsForm'}->{'y'} ||= $defaultHeight;

 <div id="theFlashCardsForm" class="hiddenDiv" style="z-index:9999; width:<% $formWidth %>px; height:<% $formHeight %>px; display:none; left:<% $m->session->{'contentMenuLocation'}->{'theFlashCardsForm'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'theFlashCardsForm'}->{'y'} %>px; overflow:hidden;">
    <& SELF:printDragHandleWithClose, formName => 'theFlashCardsForm', title => __('My Flash Cards'), imageName => 'saveFormButton' &>
    <div id="innerObjectiveDiv" style="width:<% $formWidth %>px; height: <% $formHeight - $closeHandleHeight %>px; overflow:auto;">

	<form name="theTuskSaveForm" id="theTuskSaveForm" method="post" action="" onsubmit="submitContent(this.content_item.value,document.getElementById('add_to_folder').value,'/tusk/management/flashcard/flashcard?content_item='+this.content_item.value+'&add_to_folder='+document.getElementById('add_to_folder').value, 'savedcard' );return false;"> 
       <input type="hidden" name="content_item" value="/<% $document->primary_key()  %>" />
	<table border="0" class="tableWithLittleFont">
          <tr><td><a href="/management/flashcard/flashcard"><%__('Manage Flash Card Decks')%></a></td></tr>
          <tr><td><%__('Save in Deck:')%></td></tr>
          <tr><td>
            <select id="add_to_folder" name="add_to_folder" onChange="if(this[this.length-1].value == 'select') {this.length--;}">
%  foreach my $folder ($m->session->{'user'}->child_personal_content) {
%  		if(	$folder->field_value('type') eq "Flash Card Deck" ){
              <option value="<% $folder->primary_key %>"><% $folder->out_label() %></option>
% } }  
              <option value="-1"> * <%__('Add New Deck')%> * </option>
              <option value="select" selected><%__('Select')%></option>
            </select>
          </td></tr>
		  
          <tr><td><input type="submit" class="formbutton" onClick="
if(document.getElementById('add_to_folder').value == -1) { 
	 document.getElementById('theTuskSaveForm').onsubmit='';  
	 document.getElementById('theTuskSaveForm').action='/management/flashcard/flashcard'; 
}
if(document.getElementById('add_to_folder').value == 'select')
 {alert(_('You must select a folder to save this content into'));  return false;}"
 name="Add" value="<%__('Save')%>"</td></tr><tr></tr>
		<tr><td><div id="savedcard" style="display:none;color:red;weight:bold;"><%__('Your card has been saved')%>.</div></td></tr>
        </table>
      </form>      
    </div>
  </div>

</%method>

<%method printSaveForm>
%  my $formWidth = 200;
%  my $formHeight = 150;
%  $m->session->{'contentMenuLocation'}->{'theSaveForm'}->{'x'} ||= $tempWidth;
%  $m->session->{'contentMenuLocation'}->{'theSaveForm'}->{'y'} ||= $defaultHeight;

  <div id="theSaveForm" class="hiddenDiv" style="z-index:9999; width:<% $formWidth %>px; height:<% $formHeight %>px; display:none; left:<% $m->session->{'contentMenuLocation'}->{'theSaveForm'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'theSaveForm'}->{'y'} %>px; overflow:hidden;">
    <& SELF:printDragHandleWithClose, formName => 'theSaveForm', title => __('My Folders'), imageName => 'saveFormButton' &>
    <div id="innerObjectiveDiv" style="width:<% $formWidth %>px; height: <% $formHeight - $closeHandleHeight %>px; overflow:auto;">

      <form name="theTuskSaveForm2" id="theTuskSaveForm2" method="post" action="" onsubmit="submitContent(this.content_item.value,document.getElementById('add_to_pfolder').value,'/tusk/management/content/personalcontent?content_item='+this.content_item.value+'&add_to_pfolder='+document.getElementById('add_to_pfolder').value, 'savedpcontent' );return false;">
	<!-- /management/content/personalcontent -->
        <input type="hidden" name="content_item" value="/<% $document->primary_key()  %>" />
	<table border="0" class="tableWithLittleFont">
          <tr><td><a href="/management/content/personalcontent"><%__('Manage Personal Folders')%></a></td></tr>
          <tr><td><%__('Save in Personal Folder:')%></td></tr>
          <tr><td>
            <select id="add_to_pfolder" name="add_to_pfolder" onChange="if(this[this.length-1].value == 'select') {this.length--;}">
%  foreach my $folder ($m->session->{'user'}->child_personal_content) {
% 		if(	$folder->field_value('type') ne "Flash Card Deck" ){
              <option value="<% $folder->primary_key %>"><% $folder->out_label() %></option>
%  } }
              <option value="-1"> * <%__('Add New Folder')%> * </option>
              <option value="select" selected><%__('Select')%></option>
            </select>
          </td></tr>
          <tr><td>
<input type="submit" class="formbutton" 
onClick="
if(document.getElementById('add_to_pfolder').value == -1) {
         document.getElementById('theTuskSaveForm2').onsubmit='';
         document.getElementById('theTuskSaveForm2').action='/management/content/personalcontent';
}
if(document.getElementById('add_to_pfolder').value == 'select')
 {alert(_('You must select a folder to save this content into'));  return false;}"
 name="Add" value="<%__('Save')%>">

</td></tr>
 <tr><td><div id="savedpcontent" style="display:none;color:red;weight:bold;"><%__('Your content has been saved.')%></div></td></tr>

        </table>
      </form>
    </div>
  </div>
</%method>


<%method printZoomForm>
  <%args>
    $SIZE
  </%args>

%  $m->session->{'contentMenuLocation'}->{'theZoomForm'}->{'x'} ||= $tempWidth;
%  $m->session->{'contentMenuLocation'}->{'theZoomForm'}->{'y'} ||= $defaultHeight;

  <div id="theZoomForm" class="hiddenDiv" style="z-index:9999; display:none; width:<% 4*($iconWidth+1) %>px; height:<% $iconWidth+2+$closeHandleHeight %>px; left:<% $m->session->{'contentMenuLocation'}->{'theZoomForm'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'theZoomForm'}->{'y'} %>px; overflow:hidden;">
    <& SELF:printDragHandleWithClose, formName => 'theZoomForm', title => __('Image Zoom'), imageName => 'topZoomImage' &>
%  my $style = 'style="border:0px none gray; padding:0px; margin:0px;"';
%  my $background;
      <table border="0" width="<% (4 * $iconWidth)+2 %>" cellspacing="0" cellpadding="0">
        <tr>
          <td style="border-right:1px solid lightgrey;">
%  if(  (($document->type eq "Slide") || ($document->type eq "Flashpix")) && ($SIZE ne 'medium')  )
%    {$background = "onMouseOver=\"highlightButton(this);\" onMouseOut=\"removeHighlighting(this);\" onClick=\"loadImage(this.id);\"";}
%  else {$background = 'style="background-color: lightgrey;"';}
            <img id="medium" src="<% $imageDir %>/zoommedium.gif" <% $background %> <% $style %> title=__("Zoom Medium") alt=__("Zoom Medium")>
          </td>
          <td style="border-right:1px solid lightgrey;">
%  if(  (($document->type eq "Slide") || ($document->type eq "Flashpix")) && ($SIZE ne 'large')  )
%    {$background = "onMouseOver=\"highlightButton(this);\" onMouseOut=\"removeHighlighting(this);\" onClick=\"loadImage(this.id);\"";}
%  else {$background = 'style="background-color: lightgrey;"';}
            <img id="large" src="<% $imageDir %>/zoomlarge.gif" <% $background %> <% $style %> title=__("Zoom Large") alt=__("Zoom Large")>
          </td>
          <td style="border-right:1px solid lightgrey;">
%  if(  (($document->type eq "Slide") || ($document->type eq "Flashpix")) && ($SIZE ne 'xlarge')  )
%    {$background = "onMouseOver=\"highlightButton(this);\" onMouseOut=\"removeHighlighting(this);\" onClick=\"loadImage(this.id);\"";}
%  else {$background = 'style="background-color: lightgrey;"';}
            <img id="xlarge" src="<% $imageDir %>/zoomxlarge.gif" <% $background %> <% $style %> title=__("Zoom Extra Large") alt=__("Zoom Extra Large")>
          </td>
%  if(  (($document->type eq "Slide") || ($document->type eq "Flashpix")) && ($SIZE ne 'orig')  )
%    {$background = "onMouseOver=\"highlightButton(this);\" onMouseOut=\"removeHighlighting(this);\" onClick=\"loadImage(this.id);\"";}
%  else {$background = 'style="background-color: lightgrey;"';}
          <td><img id="orig" src="<% $imageDir %>/zoomorig.gif" <% $background %> <% $style %> title=__("Zoom Original") alt=__("Zoom Original")></td>
        </tr>
      </table>
    <form name="theZoomForm" method="get">
    </form>
  </div>
</%method>




<%method printKeywordsForm>
  <%args>
    $keyWordsRef
    $conceptsRef
  </%args>

%  my @keyWords = @{$keyWordsRef};
%  my @concepts = @{$conceptsRef};
%  my $keywordsTitle = __("Click to highlight keywords in document");
%  my $conceptTitle = __("Click to view concept");
%  my $formWidth = 400;
%  my $formHeight = 400;
%  $m->session->{'contentMenuLocation'}->{'theKeyWordForm'}->{'x'} ||= $tempWidth;
%  $m->session->{'contentMenuLocation'}->{'theKeyWordForm'}->{'y'} ||= $defaultHeight;

%  if((scalar(@concepts) == 0) && (scalar(@keyWords) == 0)) {$formHeight = 100;}
%  elsif((scalar(@concepts) == 0) || (scalar(@keyWords) == 0)) {$formHeight = 300;}

  <div id="theKeyWordForm" class="hiddenDiv" style="z-index:9999; width:<% $formWidth %>px; height:<% $formHeight %>px; display:none; left:<% $m->session->{'contentMenuLocation'}->{'theKeyWordForm'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'theKeyWordForm'}->{'y'} %>px; overflow:hidden;">
    <& SELF:printDragHandleWithClose, formName => 'theKeyWordForm', title => __('Keywords'), imageName => 'keywordsButton' &>
    <div id="innerObjectiveDiv" style="width:<% $formWidth %>px; height: <% $formHeight - $closeHandleHeight %>px; overflow:auto;">
      <form name="theTuskWordForm">
        <table border="0" class="tableWithLittleFont" width="100%">
          <tr><td title="<% $conceptTitle %>"><b><%__('UMLS Concepts')%></b>:</td></tr>
          <tr>
            <td align="center" title="<% $conceptTitle %>">
%  if(scalar(@concepts) > 0) {
              <div id="UMLSConcepts" class="multiselectdiv" style="width:<% $formWidth - 25 %>px;">
                <table border="0" width="100%" cellspacing="0" style="background-color:#E7EFF7;">
%    my %conceptHash;  
%    foreach my $concept (@concepts) {
%      $conceptHash{lc($concept->getKeyword)}{id} = $concept->getConceptID;
%      $conceptHash{lc($concept->getKeyword)}{displayValue} = $concept->getKeyword;
%    }
%    foreach my $hashKey (sort keys %conceptHash) {
                  <tr onMouseOver="this.style.backgroundColor='lightgrey';" onMouseOut="this.style.backgroundColor='';"
                   style="cursor:pointer;" onClick="document.location='/hsdb4/concept/<% $conceptHash{$hashKey}{id} %>';"
                  ><td class="bold_emphasis_font"><% $conceptHash{$hashKey}{displayValue} %></td></tr>
%    }
                </table>
              </div>
%  } else {
<%__('There are no UMLS concepts.')%>
%  } 
            </td>
          </tr>
          <tr><td title="<% $keywordsTitle %>"><b><%__('Keywords')%></b>:</td></tr>
          <tr>
            <td align="center" title="<% $keywordsTitle %>" width="100%">
%  if($#keyWords >= 0) {
              <select multiple size="10" name="keyWords" onClick="highlightWords();" style="width:<% $formWidth - 25 %>px;">
%    foreach (sort {lc $a cmp lc $b} @keyWords) {$m->print("<option value=\"$_\">$_</option>");}
              </select>
%  } else {
<%__('There are no keywords.')%>
%  }
            </td>
          </tr>
        </table>
      </form>
    </div>
  </div>
</%method>



<%method printLinkedDocsForm>
  <%args>
    $contextRef
    $subContentRef
    $linkedFrom
  </%args>

%  my @context = @{$contextRef};
%  my @subContent = @{$subContentRef};
%  my $formWidth = 450;
%  my $formHeight = 250;
%  my $bgcolor = 1;
%  $m->session->{'contentMenuLocation'}->{'theLinkedDocsForm'}->{'x'} ||= $tempWidth;
%  $m->session->{'contentMenuLocation'}->{'theLinkedDocsForm'}->{'y'} ||= $defaultHeight;

%  if(!$linkedFrom) {$formHeight = 100;}
%  else             {$formHeight = 300;}

  <div id="theLinkedDocsForm" class="hiddenDiv" style="z-index:9999; width:<% $formWidth %>px; height:<% $formHeight %>px; display:none; left:<% $m->session->{'contentMenuLocation'}->{'theLinkedDocsForm'}->{'x'} %>px; top: <% $m->session->{'contentMenuLocation'}->{'theLinkedDocsForm'}->{'y'} %>px; overflow:hidden;">
    <& SELF:printDragHandleWithClose, formName => 'theLinkedDocsForm', title => __('Linked Documents'), imageName => 'linkedToButton' &>
    <div id="innerObjectiveDiv" style="width:<% $formWidth %>px; height: <% $formHeight - $closeHandleHeight %>px; overflow:auto;">
      <table border="0" width="100%" class="tableWithLittleFont">
          <tr><td><b><%__('Also Linked From')%></b>:</td></tr>
          <tr>
            <td align="center">
%  if($linkedFrom) {
              <div class="multiselectdiv" style="width:<% $formWidth - 25 %>px;">
                <table border="0" width="100%" cellspacing="0" style="background-color:#E7EFF7;">
%    $bgcolor = 1;
%    foreach my $parentContent (@context) {
%       if($bgcolor) {$bgcolor = '';} else {$bgcolor = 'lightgrey';}
        <tr style="background-color:<% $bgcolor %>;" onMouseOver="this.style.backgroundColor='yellow';" onMouseOut="this.style.backgroundColor='<% $bgcolor %>';">
          <td><a href="<% $parentContent->out_url %>"><% $parentContent->field_value('title') %></a></td>
        </tr>
%    } 
                </table>
              </div>
%  } else {
              <p><%__('Not Linked From Other Documents.')%></p>
%  } 
            </td>
          </tr>
        </table>
      </form>
    </div>
  </div>
</%method>

<%method displayContentOptionMenuItem>
<%args>
        $menuItemText
        $menuItemHelpText
        $onClick	=> ''
	$active		=> 1
	$showArrow	=> 1
	$onMouseOver	=> 'highlightButton(this);'
	$onMouseOut	=> 'removeHighlighting(this);'
        $background	=> 'background-color:lightgrey;'
	$extraImg	=> ''
	$menuID		=> ''
</%args>
%
% unless ($menuID){
%	$menuID = $menuItemText . '_id';
% 	$menuID =~ s/ /_/g;
% }
%
<tr>
        <td
		valign="middle" 
		colspan="<% $iconsInTopRow %>" 
		title="<% $menuItemHelpText %>" 
		align="left" 
		id="<% $menuID %>" 
		style="width:100%; cursor:pointer; border-bottom:<% $grayborder %>; <% ($active) ? '' : $background %>" 
		onClick="<% $onClick %>" 
		onMouseOver="<% ($active) ? $onMouseOver : '' %>" 
		onMouseOut="<% ($active) ? $onMouseOut : '' %>" 
		>
                <table style="width:100%;" cellpadding="0">
                        <tr>
                                <td valign="middle" align="left"><font style="font-size:8pt;"><% $menuItemText %></font></td>
% 
% if ($extraImg){
			<td valign="middle" align="right"><% $extraImg %></td>
%
% }
%
%
% if ($showArrow){
%
                                <td valign="middle" align="right"><img align="right" src="/graphics/rightArrow.gif"></td>
%
% }
%
                        </tr>
                </table>
        </td>
</tr>
</%method>

<%method display_content>
<%args>
$summary => 0
$document
$justcontent => 0
</%args>

%	my ($course_uri_id, $garbage) = split( "/", $document->aux_info('uri_path') );
%	my ($school_code, $course_code) = $course_uri_id =~ /([A-Z])(\d+).*/;
%	my $course;
%   $course = HSDB45::Course->new( _school => HSDB4::Constants::school_codes($school_code) )->lookup_key( $course_code ) if ($school_code && $course_code);
%	my $is_integrated_course = (defined($course) && $course->type() eq 'integrated course') ? 1 : 0;
%	my $view_by;
%	if($document->aux_info('uri_path')) {$contentPK = $document->aux_info('uri_path') . "/" . $document->primary_key();}

% my $additional_class = ($document->content_type() eq 'TUSKdoc' && !$iCanEdit)? 'tdNotEdit' : '';
% $additional_class .= ($justcontent) ? ' justcontent' : '';
<div id="pageContent" class="<% $additional_class %>">
% if ( $is_integrated_course && $document->content_type() eq 'Collection' ) {
		<script type="text/javascript">
		function update_view() {
			document.getElementById("theTableWrapperDiv").innerHTML = '';
			clearLoadedContentIDs();
			requestSubContent(0, '<% $contentPK %>', '', '');
		}
		</script>
		<table cellpadding="3" cellspacing="3" class="viewby">
			<tr>
				<td><% __('View By') %>:</td>
				<td>
					<select id="view_by" onchange="update_view();">
						<option value=""><% $course->title %></option>
%					foreach ( @{$course->get_subcourses} ) {
%						my $selected = '';
%						if ( $m->session->{$course->course_id . "_filter"} == $_->course_id ) { $selected = ' selected'; }
						<option value="<% $_->course_id %>"<% $selected %>><% $_->title %></option>
%					}
					</select>
				</td>
				<td align="right">
			        <div id="loadingDiv" style="visibility:hidden;">
          		 		<img id="theLoadingImage" src="/graphics/icons/waiting_bar.gif">
        			</div>
				</td>
			</tr>
		</table>
% }
%my $xsl_dir = "$ENV{XSL_ROOT}/Content";
%if($document->type() eq 'TUSKdoc' or (defined($document->conversion_status) && $document->conversion_status > 0)) {
%	if($summary) {$document->xsl_stylesheet($xsl_dir."/DocumentSummary.xsl");} else {$document->xsl_stylesheet($xsl_dir."/Document.xsl");}
%}
% my $body = $document->out_html_body(%ARGS); 
% if($document->error) {
	  <div class="error">
	    <%__x('This document cannot be displayed at this time.  Please email <a href="{support_email}">{support_email}</a> if you have a question.', support_email => $TUSK::Constants::SupportEmail)%>
	 </div>
%		ErrorReport::sendErrorReport($r, {'Msg'=>$document->error()});
%} else {
%	if ($document->content_type() eq 'Collection') {
%		if($body) {
	  <table width="75%"><tr><td width="1%" valign="top"><%__('Folder&nbsp;Notes:')%></td><td><% $body %></td></tr></table><br>
%		}
%		my %displayedCollections;
%		my @subContent = $document->active_child_content();
%		if($document->display_child_content && @subContent > 0) {
%#        Here we need to see if there is a parent course or not!
		<div id="theTableWrapperDiv">
		</div>
%			$m->comp('/tmpl/content:drawContentTable', documentID => $contentPK, integrated_course => $is_integrated_course );
%		}
%	} 
%	else {
%		if ( ($document->content_type() eq 'TUSKdoc' && $iCanEdit) && $document->showConversionStatus() ) {
%			$m->comp('/tmpl/content:getStatusRetrievalMsg', content_id => $document->primary_key());
%		}
	  <% $body %>
%	}
%}

% unless($justcontent){
<%doc>output the created and last modified</%doc>
% my $ctime = HSDB4::DateTime->new;
% my $mtime = HSDB4::DateTime->new;
% $ctime->in_mysql_timestamp($document->field_value("created"));
% $mtime->in_mysql_timestamp($document->field_value("modified"));
  <table class="contentmeta">
    <tr>
% if($ctime->out_string_date eq '') {
      <td><b><%__('Created:')%></b></td><td><%__('Unknown')%></td>
% } else {
      <td><b><%__('Created:')%></b></td><td nowrap style="white-space:nowrap;"><% $ctime->out_string_date %></td>
% }
      <td align="right">
% if($document->out_html_appendix() eq '') {
        &nbsp;
% } else {
        <%doc>Print the appendix</%doc>
        <% $document->out_html_appendix() %>
% }
      </td>
    </tr>
% unless($mtime->out_string_date eq '') {
    <tr><td><b><%__('Modified:')%></b></td><td nowrap style="white-space:nowrap;"><% $mtime->out_string_date %></td><td>&nbsp;</td></tr>
% }
  </table>
% }
  </div>

</%method>
