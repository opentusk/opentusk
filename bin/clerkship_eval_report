#!/usr/bin/perl -l
use FindBin;
use lib "$FindBin::Bin/../lib";

use strict;

use MySQL::Password;
use HSDB4::Constants;
use HSDB4::SQLRow::Eval;
use HSDB4::SQLRow::EvalQuestion;
use Getopt::Long;

HSDB4::Constants::set_user_pw (get_user_pw);

sub show_usage {
    print STDERR "Usage:";
    print STDERR "$0 --eval_id=<eval_id> [ --start_date=<date> ] [ --end_date=<date> ]";
}

my ($eval_id, $startdate, $stopdate);
GetOptions ("eval_id=s" => \$eval_id,
	    "start_date:s" => \$startdate,
	    "end_date:s" => \$stopdate);

my $eval = HSDB4::SQLRow::Eval->new->lookup_key ($eval_id);
$eval->primary_key or show_usage, exit -1;

my ($n, $mean, $groups) = (0, 0, 0);
sub rezero { ($n, $mean, $groups) = (0, 0, 0); }
sub make {
    my ($a, $b) = @_;
    $n += $a;
    $mean += $a * $b;
    $groups++;
    return sprintf "<b>Mean</b>: %.2f (N=%d)</td>", $b, $a;
}

sub radio_clean_up {
    my $out = shift;
    $out =~ s!<tr><td colspan=4><img src="/icons/transdot.gif"[^>]+></td></tr>\n!!msg;
    rezero ();
    $out =~ s!<b>N</b>: (\d+)<br>\n<b>Mean:</b> ([\d\.]+)<br>[^%]+%</td>!make($1,$2)!msge;
    $out =~ s!<b>N:</b> (\d+)\n<br><b>Value:</b> (\d+)\n</td>!make ($1, $2)!msge;
    $out .= sprintf ("<tr><td>&nbsp;</td><td colspan=3><b>Total Mean:</b> %.2f</td></tr>\n",
		     $mean/$n) if $groups > 1;
    $out =~ s/<td width="20%">/<td>/g;
    $out .= "<tr><td colspan=4>&nbsp;</td></tr>\n";
    return $out;
}

sub clean_up {
    my $out = shift;
    $out =~ s!<tr><td colspan=4><img src="/icons/transdot.gif"[^>]+></td></tr>\n!!msg;
    $out =~ s/<td width="20%">/<td>/g;
    $out .= "<tr><td colspan=4>&nbsp;</td></tr>\n";
    return $out;
}

my $cond = "";
if ($startdate && $stopdate) {
    $cond = "unix_timestamp(year) between unix_timestamp(\"$startdate\") and unix_timestamp(\"$stopdate\")"}
elsif ($startdate) {
    $cond = "unix_timestamp(year) >= unix_timestamp(\"$startdate\")";
}
elsif ($stopdate) {
    $cond = "unix_timestamp(year) <= unix_timestamp(\"$stopdate\")";
}

my @questions = $eval->child_eval_questions;
print '<html><head><title>Evaluation Report</title>';
print '<base href="http://hsdb.hsl.tufts.edu/">';
print '<body>';
print '<h3 class="title">Evaluation Report: ' . $eval->out_label () . '</h3>';
print '<h4 class="title">Start Date: ' . $startdate . '</h4>' if $startdate;
print '<h4 class="title">End Date: ' . $stopdate . '</h4>' if $stopdate;
print '<table class="wide" cellspacing="2">';
my @comments = ();
my @radiobox = ();
foreach my $question (@questions) {
    if ($question->question_type eq 'radio-box') { push @radiobox, $question }
    elsif ($question->question_type eq 'fill-in') { push @comments, $question }
}
foreach my $question (@radiobox) {
    $question->set_block_condition ($cond) if $cond;
    my $out = $question->out_html_response_summary;
    print radio_clean_up ($out);
}
foreach my $question (@comments) {
    $question->set_block_condition ($cond) if $cond;

    my $out = $question->out_html_response_summary;
    print clean_up ($out);
}
print '</table></body></html>';

1;
__END__
