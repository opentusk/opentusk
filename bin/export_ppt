#!/usr/bin/perl
# Copyright 2012 Tufts University 
#
# Licensed under the Educational Community License, Version 1.0 (the "License"); 
# you may not use this file except in compliance with the License. 
# You may obtain a copy of the License at 
#
# http://www.opensource.org/licenses/ecl1.php 
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
# See the License for the specific language governing permissions and 
# limitations under the License.

use FindBin;
use lib "$FindBin::Bin/../lib";

use strict;
use warnings;

use HSDB4::Constants;
use HSDB45::Course;

our %exported = ();

my $dbh = HSDB4::Constants::def_db_handle();
my $sql = qq(
    SELECT vc.course_id, vc.title
    FROM tusk.academic_level al, tusk.academic_level_course alc, tusk.course c, hsdb45_vet_admin.course vc
    WHERE al.academic_level_id = alc.academic_level_id
    AND c.school_course_code = vc.course_id
    AND alc.course_id = c.course_id
    AND al.school_id = 3
    ORDER BY vc.oea_code
);
my $sth = $dbh->prepare($sql);
$sth->execute();
my $results = $sth->fetchall_arrayref();
$sth->finish();

foreach my $result (@$results) {
    my $course_id = $result->[0];
    my $title = $result->[1];
    my $oea_code = $result->[2];
    print "mkdir $course_id #$title\n";

    my $course = HSDB45::Course->new(_school => 3)->lookup_key($course_id);
    export($course_id, $course->child_content());
}

sub export {
    my $course_id = shift;

    foreach my $content (@_) {
        my $content_id = $content->content_id();
        next if $exported{"$course_id/$content_id"};
        $exported{"$course_id/$content_id"} = 1;
        my $type = $content->type();
        if ($type =~ /Collection|Multidocument/) {
            export($course_id, $content->child_content())
        } elsif ($type eq 'DownloadableFile') {
            my $file = $content->out_file_path();
            print "ln $file $course_id\n" if ($file =~ m/^.*\.pp[st]x?$/i);
        }
    }
}

